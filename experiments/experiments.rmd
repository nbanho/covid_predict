---
title: "Experiments"
author: "Nicolas Banholzer"
date: '2022-04-21'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
# libraries
library(tidyverse)
# Suppress summarise info
options(dplyr.summarise.inform = FALSE)
library(reshape2)
library(lubridate)

# utils
source("../utils/eval.r")
source("../helper/plotting.r")

# compute scores
score_experiment <- function(files, parameter, model) {
  scores_df <- tibble()
  for (f in 1:length(files)) {
    print(f)
    df <- readRDS(files[f])
    for (p in parameter) {
      print(p)
      df_p <- df %>% mutate(data = map(data, function(D) 
        D %>% 
          select(all_of(c("date", "cases", "incidence", paste0(model, "-", p)))) %>%
          set_names(c("date", "cases", "incidence", "forecast"))))
      crps <- compute_forecast_score(df = df_p, model = model) %>%
        mutate(variable = p)
      scores_df <- rbind(scores_df, crps)
    }
  }
  return(scores_df)
}

# summarize scores
summarize_scores <- function(scores_df) {
  scores_df <- scores_df %>%
    group_by(model, variable, n) %>%
    summarize(score = mean(score)) %>%
    ungroup()
  return(scores_df)
}

# plot function
plot_experiment <- function(score_df, col_blues, expr, title) {
  n_cols <- length(unique(score_df$variable))
  cols <- brewer.pal(9, "Blues")[col_blues]
    
  score_df %>%
    ggplot(aes(x = n, y = score, color = factor(variable))) +
    geom_line() +
    geom_point(shape = 1) +
    scale_x_continuous(breaks = seq(1,2), labels = function(x) paste("Week", x)) +
    scale_y_continuous(limits = c(0,1)) +
    scale_color_manual(values = cols) +
    labs(y = "Average CRPS", color = expr, title = title) +
    theme_bw2() +
    theme(axis.title.x = element_blank(), legend.position = "top") 
}
```

## Mechanistic models

### EpiEstim

```{r}
# data
files_epiestim <- list.files("epiestim/", full.names = T)
tau = c(1,7,14)

# compute scores
scores_epiestim <- score_experiment(files_epiestim, tau, "epiestim")

# summarize scores
scores_epiestim_sum <- summarize_scores(scores_epiestim)

# plot 
epiestim_pl <- plot_experiment(scores_epiestim_sum, c(4,6,8), expression("EpiEstim with "*tau*":"), "a")
epiestim_pl
```

## Stat TS models

### ARIMA

```{r}
# data
files_arima <- list.files("arima/", full.names = T)
pdq_orders <- matrix(c(1,0,1,
                       1,1,1,
                       2,0,2,
                       2,1,2,
                       2,2,2),
                     ncol = 3, byrow = T)
pdq_name <- apply(pdq_orders, 1, paste, collapse = "")

# compute scores
scores_arima <- score_experiment(files_arima, pdq_name, "arima")

# summarize scores
scores_arima_sum <- summarize_scores(scores_arima) %>%
  mutate(variable = map_chr(variable, function(x) paste0("(", paste0(unlist(strsplit(x, "*")), collapse = ","),  ")")))

# plot 
arima_pl <- plot_experiment(scores_arima_sum, c(4,5,6,7,9), expression("SARIMA(p,d,q)(0,1,0)"[7]*":"), "d")
arima_pl
```


### Prophet

```{r}
# data
files_prophet <- list.files("prophet/", full.names = T)
cp_scale <- seq(0.05, 0.45, 0.1)

# compute scores
scores_prophet <- score_experiment(files_prophet, cp_scale, "prophet")

# summarize scores
scores_prophet_sum <- summarize_scores(scores_prophet)

# plot 
prophet_pl <- plot_experiment(scores_prophet_sum, c(2,4,6,8,9), expression("Prophet with "*tau*":"), "d")
prophet_pl
```


### GP

```{r}
# data
files_gp <- list.files("gp/", full.names = T)
rhos <- c(1,7,14)

# compute scores
scores_gp <- score_experiment(files_gp, rhos, "gp")

# summarize scores
scores_gp_sum <- summarize_scores(scores_gp)

# plot 
gp_pl <- plot_experiment(scores_gp_sum, c(2,4,6,8,9), expression("GP with "*rho*" in short-term kernel:"), "e")
gp_pl
```
