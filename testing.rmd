---
title: "Testing"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
# general
library(tidyverse)
library(tidybayes)
library(lubridate)

# default settings
source("settings/defaults.r")

# train and predict utils
source("utils/train.r")
source("utils/predict.r")
source("utils/transform.r")

# delays
source("utils/delays.r")

# EpiEstim
source("models/cori.r")
source("utils/predict.r")

# Epidemia
source("models/epidemia.r")

# ARIMA
source("models/arima.r")
library(astsa)

# Prophet
source("models/prophet.r")
```

## Data

```{r}
# all data
df <- read_csv("data/prep_jhu_all_countries.csv") %>%
    dplyr::filter(id %in% c("AUT", "BEL", "BGR", "CHE", "HRV", "CZE", "DNK", "EST", 
                            "FIN", "FRA", "DEU", "GRC", "HUN", "IRL", "ITA", "LVA",
                            "LTU", "NLD", "POL", "PRT", "ROU", "SVK",
                            "SVN", "ESP", "SWE", "GBR"))

# country to test loop
countries <- c("DEU")
```

### New cases

```{r}
df %>% 
  dplyr::filter(date <= "2020-05-01") %>%
  ggplot(aes(x = date, y = new_confirmed)) +
  geom_line() +
  facet_wrap(~ id, scales = "free_y")
```

### Determine cap

```{r}
df %>%
  group_by(id) %>%
  summarize(m = max(new_confirmed) / population[1] * 1e5) %>%
  ungroup() %>%
  ggplot(aes(x = id, y = m)) +
  geom_bar(stat = "identity")
```

## EpiEstim 

### Under the hood

```{r}
# configure serial interval
# config_si <- make_config(
#     method = "uncertain_si",
#     mean_si = 5.61,
#     std_mean_si = 0.30,
#     min_mean_si = 5.61 - 2,
#     max_mean_si = 5.61 + 2,
#     std_si = 4.83,
#     std_std_si = 0.37,
#     min_std_si = 4.83 - 2,
#     max_std_si = 4.83 + 2,
#     n1 = 100,
#     n2 = 40,
#     seed = 1)
config_si <- make_config(
  method = "non_parametric_si",
  si_distr = vp(xT = 10, from0 = F, FUN = p_g))

# data
data <- df %>%
  dplyr::filter(id == "AUT") %>%
  arrange(date) %>%
  slice(1:90)

# Estimate R
est_R <- estimate_R(
  incid = data$new_confirmed,
  method = "non_parametric_si",
  config = config_si)

# Simulate plausible R
mean_r <- tail(est_R$R$`Mean(R)`, 1)
sd_r <- tail(est_R$R$`Std(R)`, 1)
shapescale <- gamma_mucv2shapescale(mu = mean_r, cv = sd_r/mean_r)
set.seed(1)
plausible_r <- rgamma(4e3, shape = shapescale$shape, scale = shapescale$scale)
  
# make projections
inc <- incidence(est_R$dates)
inc$counts <- as.matrix(est_R$I)
#sis <- lapply(seq_len(nrow(est_R$si_distr)), function(i) est_R$si_distr[i, ])
#proj <- map(sis, function(S) as.matrix(project(x = inc, R = plausible_r, si = S[-1], n_sim = 40, n_days = 21)))
#proj <- do.call(cbind, proj)
proj <- project(inc, plausible_r, config_si$si_distr[-1], n_sim = 4e3, model = "negbin", instantaneous_R = T)

# evaluation
test_data <- df %>%
  dplyr::filter(id == "AUT") %>%
  arrange(date) %>%
  slice(91:111)

pred <- cbind(date = test_data$date, data.frame(proj)) %>%
  reshape2::melt(c("date")) 

ggplot(mapping = aes(x = date)) +
  stat_lineribbon(data = pred, mapping = aes(y = value)) +
  geom_line(data = test_data, mapping = aes(y = new_confirmed)) +
  scale_fill_brewer()
```

### Test functions

```{r}
# train
cori.fit <- train.cori(data$new_confirmed)

# predict
cori.proj <- predict.cori(estimate_R_obj = cori.fit)
```

### Train & Pred

```{r}
results_ee <- list()

for (j in 1:length(countries)) {
  
  # data
  ctry <- countries[j]
  df_ctry <- subset(df, id == ctry)
  
  # test data
  test_df_ctry <- slice(df_ctry, (n_train+1):nrow(df_ctry))
  
  # R estimates
  trained_cori <- train(df_ctry %>% rename(target = new_confirmed), method = "cori")
  
  # predictions
  pred_mat <- matrix(NA, ncol = n_preds, nrow = nrow(test_df_ctry))
  for (k in 1:nrow(test_df_ctry)) {
    preds <- predict(train_obj =  trained_cori, i = n_train + k - 1, n = n_preds, d = n_draws)
    mean_preds <- rowMeans(preds)
    pred_mat[k, ] <- mean_preds
  }
  
  # combine
  pred_df <- data.frame(pred_mat) %>%
    set_names(paste0("pred_ahead_", 1:n_preds)) %>%
    mutate(id = ctry,
           date = test_df_ctry$date) %>%
    reshape2::melt(c("id", "date"))  %>%
    rename(n_ahead = variable) %>%
    mutate(n_ahead = as.numeric(stringi::stri_extract(n_ahead, regex = "\\d{1,2}"))) %>%
    mutate(date = date %m+% days(n_ahead))
  write_csv(pred_df, paste0("predictions/cori/", ctry, ".csv"))
  results_ee[[j]] <- pred_df
}

results_ee_df <- do.call(rbind, results_ee)
results_ee_df <- left_join(results_ee_df, dplyr::select(df, id, date, new_confirmed))
```

### Evaluation

```{r}
ggplot() +
  geom_line(data = results_ee_df, mapping = aes(x = date, y = value, color = n_ahead)) +
  geom_line(data = subset(results_ee_df, n_ahead == 1), mapping = aes(x = date, y = new_confirmed), color = "black") +
  facet_wrap(~ id) +
  scale_color_viridis_c() +
  labs(y = "Number of new cases", color = "N") +
  theme_bw() +
  theme(axis.title.x = element_blank())
```


## Epidemia

### Under the hood

```{r}
data <- df %>%
  dplyr::filter(id == "AUT") %>%
  arrange(date) %>%
  slice(1:90) %>%
  mutate(o = 1,
         week = format(date, "%V"))

# model the rep number as weekly random walk (no covariates)
rt <- epirt(
  formula = R(id, date) ~ 1 + rw(time = week, prior_scale = 0.1),
  prior_intercept = rstanarm::normal(log(3), 0.3), 
  link = 'log'
)

# model infections with serial interval for generation time distribution
gen_distr <- vp(xT = 10, from0 = F, FUN = p_g)
gen_distr <- gen_distr / sum(gen_distr)
inf <- epiinf(
  gen = gen_distr,
  pop_adjust = T,
  pops = "population",
  latent = TRUE,
  prior_aux = rstanarm::normal(10,2)
)

# model observed cases as a proportion of infections constant over time
i2o_distr <- vp(xT = 30, from0 = F, FUN = p_in)
i2o_distr <- i2o_distr / sum(i2o_distr)
obs <- epiobs(
  formula = new_confirmed ~ 0 + offset(o),
  link = "identity",
  i2o = i2o_distr
)

# fit the model with various model params
args <- list(rt = rt, obs = obs, inf = inf, data = data,  
             chains = 4, iter = 500, cores = 4, seed = 12345, control = list(adapt_delta = 0.95, max_treedepth = 15))
fit <- do.call(epim, args)

# predict
test_data <- df %>%
  dplyr::filter(id == "AUT") %>%
  arrange(date) %>%
  slice(91:111) %>%
  mutate(o = 1,
         week = format(date, "%V"))

pred <- posterior_predict(fit, newdata = test_data)
pred_data <- cbind(date = pred$time, data.frame(t(pred$draws))) %>%
  reshape2::melt(c("date")) 

ggplot(mapping = aes(x = date)) +
  stat_lineribbon(data = pred_data, mapping = aes(y = value)) +
  geom_line(data = test_data, mapping = aes(y = new_confirmed)) +
  scale_fill_brewer()
```

### Test functions

```{r}
fit <- train.epidemia(data %>% rename(y = new_confirmed, pop = population), chain = 1, iter = 500)
pred <- predict.epidemia(fit, d = 100)
```


### Train & Pred

```{r}
results_ep <- list()

for (j in 1:length(countries)) {
  
  # data
  ctry <- countries[j]
  df_ctry <- subset(df, id == ctry) 
  
  # test data
  test_df_ctry <- slice(df_ctry, (n_train+1):nrow(df_ctry))
  
  # predictions
  pred_mat <- matrix(NA, ncol = n_preds, nrow = nrow(test_df_ctry))
  for (k in 1:nrow(test_df_ctry)) {
    train_df_ctry <- slice(df_ctry, 1:(n_train+k-1))
    trained_model <- train(dat = train_df_ctry %>% rename(target = new_confirmed), 
                           method = "epidemia", 
                           chains = 4, cores = 4, iter = 1000)
    preds <- predict(trained_model, d = 1000)
    mean_preds <- rowMeans(preds)
    pred_mat[i, ] <- mean_preds
  }
  
  # combine
  pred_df <- data.frame(pred_mat) %>%
    set_names(paste0("pred_ahead_", 1:n_preds)) %>%
    mutate(id = ctry,
           date = test_df_ctry$date) %>%
    reshape2::melt(c("id", "date"))  %>%
    rename(n_ahead = variable) %>%
    mutate(n_ahead = as.numeric(stringi::stri_extract(n_ahead, regex = "\\d{1,2}"))) %>%
    mutate(date = date %m+% days(n_ahead))
  write_csv(pred_df, paste0("predictions/epidemia/", ctry, ".csv"))
  results_ep[[j]] <- pred_df
}

results_ep_df <- do.call(rbind, results_ep)
results_ep_df <- left_join(results_ep_df, dplyr::select(df, id, date, new_confirmed))
```


### Evaluation

```{r}
ggplot() +
  geom_line(data = results_ep_df, mapping = aes(x = date, y = value, color = n_ahead)) +
  geom_line(data = subset(results_ep_df, n_ahead == 1), mapping = aes(x = date, y = new_confirmed), color = "black") +
  facet_wrap(~ id) +
  scale_color_viridis_c() +
  labs(y = "Number of new cases", color = "N") +
  theme_bw() +
  theme(axis.title.x = element_blank())
```


## ARIMA

### Toy example

```{r}
# toy model
deu_first200 <- subset(df, id == "DEU")$new_confirmed[1:200]
fit_first200 <- train.arima(deu_first200)

# predict
deu_pred <- predict.arima(fit_first200)
deu_first221 <- df %>%
  dplyr::filter(id == "DEU") %>%
  slice(1:221) %>%
  dplyr::select(date, new_confirmed)
plot.predict(deu_first221$date, deu_first221$new_confirmed, deu_pred)
```

### Train & Pred

```{r}
results_am <- list()

for (j in 1:length(countries)) {
  
  # data
  ctry <- countries[j]
  df_ctry <- subset(df, id == ctry) 
  
  # test data
  test_df_ctry <- slice(df_ctry, (n_train+1):nrow(df_ctry))
  
  # predictions
  pred_mat <- matrix(NA, ncol = n_preds, nrow = nrow(test_df_ctry))
  for (k in 1:nrow(test_df_ctry)) {
    train_df_ctry <- slice(df_ctry, tail(1:(n_train+k-1), 90))
    # train_df_ctry <- slice(df_ctry, 1:(n_train+k-1))
    train_df_ctry$log_inc <- log((train_df_ctry$new_confirmed+1)/train_df_ctry$population*1e5)
    trained_model <- train.arima(train_df_ctry$log_inc, iter = 1000)
    #trained_model <- train.arima(train_df_ctry$new_confirmed, iter = 1000)
    preds <- predict.arima(trained_model, d = 1000)
    mean_preds <- rowMeans(preds)
    #pred_mat[k, ] <- mean_preds
    pred_mat[k, ] <- exp(mean_preds) * train_df_ctry$population[1] / 1e5 -1
  }
  
  # combine
  pred_df <- data.frame(pred_mat) %>%
    set_names(paste0("pred_ahead_", 1:n_preds)) %>%
    mutate(id = ctry,
           date = test_df_ctry$date) %>%
    reshape2::melt(c("id", "date"))  %>%
    rename(n_ahead = variable) %>%
    mutate(n_ahead = as.numeric(stringi::stri_extract(n_ahead, regex = "\\d{1,2}"))) %>%
    mutate(date = date %m+% days(n_ahead))
  write_csv(pred_df, paste0("predictions/arima/", ctry, ".csv"))
  results_am[[j]] <- pred_df
}

results_am_df <- do.call(rbind, results_am)
results_am_df <- left_join(results_am_df, dplyr::select(df, id, date, new_confirmed))
```

### Evaluation

```{r}
ggplot() +
  geom_line(data = results_am_df, mapping = aes(x = date, y = value, color = n_ahead)) +
  geom_line(data = subset(results_am_df, n_ahead == 1), mapping = aes(x = date, y = new_confirmed), color = "black") +
  facet_wrap(~ id) +
  scale_color_viridis_c() +
  labs(y = "Number of new cases", color = "N") +
  theme_bw() +
  theme(axis.title.x = element_blank())
```


## Prophet

### Toy example

```{r}
deu_first200 <- df %>%
  dplyr::filter(id == "DEU") %>%
  slice(1:200) %>%
  dplyr::select(date, new_confirmed) %>%
  set_names(c("ds", "y"))
fit_first200 <- train.prophet(deu_first200)

# predict
deu_pred <- predict.prophet(fit_first200)
deu_first221 <- df %>%
  dplyr::filter(id == "DEU") %>%
  slice(1:221) %>%
  dplyr::select(date, new_confirmed)
plot.predict(deu_first221$date, deu_first221$new_confirmed, deu_pred)
```

### Train & Pred

```{r}
set.seed(12345) 

results_pt <- list()

for (j in 1:length(countries)) {
  
  # data
  ctry <- countries[j]
  df_ctry <- subset(df, id == ctry)
  
  # test data
  test_df_ctry <- slice(df_ctry, (n_train+1):nrow(df_ctry))
  
  # predictions
  pred_mat <- matrix(NA, ncol = n_preds, nrow = nrow(test_df_ctry))
  for (k in 1:nrow(test_df_ctry)) {
    train_df_ctry <- df_ctry %>%
      slice(1:(n_train+k-1)) %>%
      rename(target = new_confirmed)
    trained_model <- train(train_df_ctry)
    preds <- predict(trained_model)
    mean_preds <- rowMeans(preds)
    pred_mat[k, ] <- mean_preds
  }
  
  # combine
  pred_df <- data.frame(pred_mat) %>%
    set_names(paste0("pred_ahead_", 1:n_preds)) %>%
    mutate(id = ctry,
           date = test_df_ctry$date) %>%
    reshape2::melt(c("id", "date")) %>%
    rename(n_ahead = variable) %>%
    mutate(n_ahead = as.numeric(stringi::stri_extract(n_ahead, regex = "\\d{1,2}")))
  write_csv(pred_df, paste0("predictions/prophet/", ctry, ".csv"))
  results_pt[[j]] <- pred_df
}

results_pt_df <- do.call(rbind, results_pt)
results_pt_df <- left_join(results_pt_df, dplyr::select(df, id, date, new_confirmed))
```

### Evaluation

```{r}
ggplot() +
  geom_line(data = results_pt_df, mapping = aes(x = date, y = value, color = n_ahead)) +
  geom_line(data = subset(results_pt_df, n_ahead == 1), mapping = aes(x = date, y = new_confirmed), color = "black") +
  facet_wrap(~ id) +
  scale_color_viridis_c() +
  labs(y = "Number of new cases", color = "N") +
  theme_bw() +
  theme(axis.title.x = element_blank())
```


## Gaussian Process


### Under the hood

```{r}
# prior
sim_data <- list(T = 90,
                 x = 1:90,
                 sig = 1,
                 c0 = 45,
                 alpha1 = .1,
                 rho1 = 1,
                 alpha2 = 0.2,
                 rho2 = 1,
                 alpha3 = 10,
                 rho3 = 90)
gp_prior <- stan(file='models/gp_prior.stan', data=sim_data,
                 warmup=0, iter=4000, chains=1, seed=494838,
                 algorithm="Fixed_param", refresh=4000)

prior_draws <- gp_prior %>%
  spread_draws(y[x]) %>%
  subset( .draw %in% sample(1:4000, 10)) 

prior_draws %>%
  ggplot(aes(x=x,y=y,group=as.factor(.draw), color = as.factor(.draw))) +
  geom_line()


library(cmdstanr)
library(posterior)
library(bayesplot)

# train data
n0 <- 1
n <- 30
data <- df %>%
  dplyr::filter(id == "DEU") %>%
  slice(n0:n) %>%
  mutate(x = n0:n) %>%
  mutate(log_inc = trans(new_confirmed, population, transfct = function(x) log(x + 1)))

mean_li <- mean(data$log_inc)

plot(data$log_inc)

# test data
test_data <- df %>%
  dplyr::filter(id == "DEU") %>%
  slice((n+1):(n+21)) %>%
  mutate(x = (n+1):(n+21)) %>%
  mutate(log_inc = trans(new_confirmed, population, transfct = function(x) log(x + 1)))

data_list <- list(N1 = nrow(data), 
                  N2 = (n-n0+1)+21,
                  y1 = data$log_inc, 
                  x1 = data$x,
                  x2 = c(data$x, test_data$x))

# train
gamma_prior_param <- stan("models/tune_inv_gamma_prior.stan", data = list(l = 7, u = (n-n0+1)),
                          iter = 1, warmup = 0, chains = 1, seed = 123213, algorithm = "Fixed_param")
data_list$rho1_shape = summary(gamma_prior_param)$summary["shape",1]
data_list$rho1_scale = summary(gamma_prior_param)$summary["scale",1]
gp_mod <- cmdstan_model("models/gp.stan")
gp_mod_fit <- gp_mod$sample(
  data =  data_list,
  seed = 12345,
  chains = 2,
  parallel_chains = 2,
  iter_warmup = 500, 
  iter_sampling = 500,
  save_warmup = T
)
gp_mod_fit$summary(c("sigma", "alpha0", "rho1", "alpha1", "alpha2", "rho2"))
np = nuts_params(gp_mod_fit)
mcmc_pairs(gp_mod_fit$draws(c("rho1", "alpha0", "alpha1", "alpha2")), np = np)
mcmc_trace(gp_mod_fit$draws(c("alpha1", "rho1", "sigma"), inc_warmup = T), n_warmup = 500)

ypred <- gp_mod_fit$draws("y2") %>%
  as_draws_df() %>%
  gather() %>%
  mutate(x = (n0-1)+as.numeric(stringi::stri_extract(gsub("y2", "", key), regex = "\\d+"))) %>%
  group_by(x) %>%
  mutate(draw = 1:n()) %>%
  ungroup() %>%
  dplyr::select(-key) %>%
  rename(y = value)

ggplot() +
  stat_lineribbon(data = ypred, mapping = aes(x = x, y = y)) +
  scale_fill_brewer() +
  geom_line(data = rbind(data, test_data), mapping = aes(x = x, y = log_inc), color = "red")
```
