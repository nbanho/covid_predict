---
title: "Evaluation"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
# libraries
library(tidyverse)
library(lubridate)

# utils
source("utils/eval.r")
source("utils/delays.r")

# helper
source("helper/plotting.r")
```

## Data

```{r}
files <- list.files("predictions", pattern = ".rds", full.names = T)
```


## Plot predict

```{r}
read_files(files[1]) %>%
  get_max_N() %>%
  get_dates_ahead() %>%
  get_target_ahead() %>%
  dplyr::filter(max_N >= 11) %>%
  rowwise() %>%
  mutate_at(vars(arima, cori, prophet), ~ list(.[11,1:1000])) %>% # temporary fix
  mutate_at(vars(date_ahead, new_confirmed_ahead), ~ list(.[11])) %>% 
  unnest(cols = c("date_ahead", "new_confirmed_ahead", "arima", "cori", "prophet")) %>%
  dplyr::select(date_ahead, new_confirmed_ahead, arima, cori, prophet) %>%
  rename(date = date_ahead, observed = new_confirmed_ahead) %>%
  reshape2::melt(c("date")) %>%
  plot_predict(interval = T, smoothing = 7)
  
read_files(files[1]) %>%
  get_max_N() %>%
  get_n_ahead() %>%
  get_dates_ahead() %>%
  get_target_ahead() %>%
  rowwise() %>%
  mutate_at(vars(arima, cori, prophet), ~ list(apply(., 1, mean))) %>% # temporary fix 
  unnest(cols = c("date_ahead", "new_confirmed_ahead", "n_ahead", "arima", "cori", "prophet")) %>%
  dplyr::select(id, date_ahead, new_confirmed_ahead, n_ahead, arima, cori, prophet) %>%
  rename(date = date_ahead, observed = new_confirmed_ahead) %>%
  reshape2::melt(c("id", "date", "n_ahead")) %>%
  plot_predict(interval = F, smoothing = 7)
```


## Prediction score

```{r}
df_ps <- do.call(rbind, map(files[1:2], function(f) {
  print(sprintf("Processing file %s", f))
  read_files(f) %>%
    get_max_N() %>%
    get_n_ahead() %>%
    get_dates_ahead() %>%
    get_target_ahead() %>%
    dplyr::select(id, new_confirmed_ahead, date_ahead, n_ahead, arima, prophet, cori, population) %>%
    rowwise() %>%
    mutate_at(vars(arima, cori, prophet), ~ pred_score(., new_confirmed_ahead, population)) %>%
    unnest(cols = c("n_ahead", "date_ahead", "new_confirmed_ahead", "arima", "cori", "prophet"))
}))
```


### By ID and N

```{r}
df_ps %>%
  dplyr::select(id, n_ahead, arima, cori, prophet) %>%
  reshape2::melt(c("id", "n_ahead")) %>%
  dplyr::filter(n_ahead %in% c(5, 11, 15)) %>%
  group_by(id, n_ahead, variable) %>%
  summarize(score = as.numeric(mean(value))) %>%
  ungroup() %>%
  rename(facet_var = n_ahead) %>%
  plot_score(name = "Average conditional ranked probability score")
```

### By ID and Q

```{r}
df_ps %>%
  dplyr::filter(n_ahead == 10) %>%
  group_by(id) %>%
  mutate(qgroup = ntile(new_confirmed_ahead / population, 5)) %>%
  ungroup() %>%
  dplyr::select(id, qgroup, arima, cori, prophet) %>%
  reshape2::melt(c("id", "qgroup")) %>%
  group_by(id, qgroup, variable) %>%
  summarize(score = as.numeric(mean(value))) %>%
  ungroup() %>% 
  rename(facet_var = qgroup) %>%
  plot_score(facet_name = "Quantile: ", 
             name = "Average conditional ranked probability score for N = 10")
```


### Over time

```{r}
df_ps %>%
  dplyr::filter(n_ahead == 10) %>%
  dplyr::select(id, date_ahead, arima, prophet) %>%
  reshape2::melt(c("id", "date_ahead")) %>%
  rename(facet_var = id, date = date_ahead, score = value) %>%
  mutate(score = as.numeric(score)) %>%
  plot_score.time(smoothing = 7, facet_name = "", 
                  name = "Average conditional ranked probability score for N = 10")
```


### Overall by N

```{r}
df_ps %>%
  dplyr::select(id, n_ahead, arima, cori, prophet) %>%
  reshape2::melt(c("id", "n_ahead")) %>%
  dplyr::filter(n_ahead %in% c(5, 10, 15)) %>%
  group_by(id, n_ahead, variable) %>%
  summarize(score = mean(value)) %>%
  ungroup() %>%
  plot_score_overall()
```


## Weighted pred error

```{r}
WM <- data_delay(30, T, p_in, mu = rnorm(1e4, 10.92, 0.94), sigma = rnorm(1e4, 5.41, 0.27))
w <- WM %>%
  group_by(x) %>%
  summarize(mean_weight = mean(value)) %>%
  dplyr::select(mean_weight) %>%
  unlist()

plot(w, xlab = "Days ahead", ylab = "Weight", type = "b")

df_ps_weighted <- df_ps %>%
  rowwise() %>%
  mutate_at(vars(arima, cori, prophet), ~ . * w[n_ahead]) 
```

### By country

```{r}
df_ps_weighted %>%
  dplyr::select(id, n_ahead, arima, cori, prophet) %>%
  reshape2::melt(c("id", "n_ahead")) %>%
  dplyr::filter(n_ahead %in% c(5, 11, 15)) %>%
  group_by(id, n_ahead, variable) %>%
  summarize(score = mean(value)) %>%
  ungroup() %>%
  rename(facet_var = n_ahead) %>%
  plot_score("Weighted average CRPS")
```

### Overall

```{r}
df_ps_weighted %>%
  dplyr::select(id, n_ahead, arima, cori, prophet) %>%
  reshape2::melt(c("id", "n_ahead")) %>%
  dplyr::filter(n_ahead %in% c(5, 10, 15)) %>%
  group_by(id, n_ahead, variable) %>%
  summarize(score = mean(value)) %>%
  ungroup() %>%
  plot_score_overall(ylab = "Weighted average conditional ranked probability score")
```


## Calibration

### Coverage

```{r}
df_co <- do.call(rbind, map(files[1:2], function(f) {
  print(sprintf("Processing file %s", f))
  read_files(f) %>%
    get_max_N() %>%
    get_n_ahead() %>%
    get_dates_ahead() %>%
    get_target_ahead() %>%
    dplyr::select(id, new_confirmed_ahead, date_ahead, n_ahead, arima, prophet, cori, population) %>%
    rowwise() %>%
    mutate_at(vars(arima, cori, prophet), ~ pred_score(., new_confirmed_ahead, type = "coverage", q = 0.25)) %>%
    unnest(cols = c("n_ahead", "date_ahead", "new_confirmed_ahead", "arima", "cori", "prophet"))
}))

df_co %>%
  dplyr::select(id, n_ahead, arima, cori, prophet) %>%
  reshape2::melt(c("id", "n_ahead")) %>%
  dplyr::filter(n_ahead %in% c(5, 11, 15)) %>%
  group_by(id, n_ahead, variable) %>%
  summarize(score = 1-as.numeric(sum(value)) / n()) %>%
  ungroup() %>%
  rename(facet_var = n_ahead) %>%
  plot_score(name = "Average probability that 50%-CrI does not cover the predicted value (%)",
             labels = function(x) x * 100)
```

### Bias

```{r}
df_cb <- do.call(rbind, map(files[1:2], function(f) {
  print(sprintf("Processing file %s", f))
  read_files(f) %>%
    get_max_N() %>%
    get_n_ahead() %>%
    get_dates_ahead() %>%
    get_target_ahead() %>%
    dplyr::select(id, new_confirmed_ahead, date_ahead, n_ahead, arima, prophet, cori, population) %>%
    rowwise() %>%
    mutate_at(vars(arima, cori, prophet), ~ pred_score(., new_confirmed_ahead, type = "bias")) %>%
    unnest(cols = c("n_ahead", "date_ahead", "new_confirmed_ahead", "arima", "cori", "prophet"))
}))

df_cb %>%
  dplyr::select(id, n_ahead, arima, cori, prophet) %>%
  reshape2::melt(c("id", "n_ahead")) %>%
  dplyr::filter(n_ahead %in% c(5, 11, 15)) %>%
  group_by(id, n_ahead, variable) %>%
  summarize(score = as.numeric(mean(value))) %>%
  ungroup() %>%
  rename(facet_var = n_ahead) %>%
  plot_score(name = "Average probability to predict higher than observed value (%)",
             limits = c(0, 1), breaks = seq(0, 1, .25),
             labels = c("0.00 \n Under-predict", "0.25", "0.50 \n Well-calibrated", "0.75", "1.00 \n Over-predict"))
```


## Sharpness

```{r}
df_sp <- do.call(rbind, map(files[1:2], function(f) {
  print(sprintf("Processing file %s", f))
  read_files(f) %>%
    get_max_N() %>%
    get_n_ahead() %>%
    get_dates_ahead() %>%
    get_target_ahead() %>%
    dplyr::select(id, new_confirmed_ahead, date_ahead, n_ahead, arima, prophet, cori, population) %>%
    rowwise() %>%
    mutate_at(vars(arima, cori, prophet), ~ pred_score(., new_confirmed_ahead, population, 
                                                     type = "sharpness", q = 0.25)) %>%
    unnest(cols = c("n_ahead", "date_ahead", "new_confirmed_ahead", "arima", "cori", "prophet"))
}))

df_sp %>%
  dplyr::select(id, n_ahead, arima, cori, prophet) %>%
  reshape2::melt(c("id", "n_ahead")) %>%
  dplyr::filter(n_ahead %in% c(5, 10, 15)) %>%
  group_by(id, n_ahead, variable) %>%
  summarize(score = as.numeric(mean(value))) %>%
  ungroup() %>%
  plot_score_overall("Average length of 50% CrI")
```