---
title: "Evaluation"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
# libraries
library(tidyverse)
library(reshape2)
library(lubridate)
library(grid)
library(gridExtra)

# utils
source("utils/eval.r")
source("utils/delays.r")

# helper
source("helper/plotting.r")

# global parameters
n_brks <- c(0, 7, 14, 21)
n_lbs <- paste(c("1", "2", "3"), "-week(s) ahead forecast", sep = " ")
inc_small_brks <- c(-Inf, 10, 20, 30, 40, 50, 60, 80, 100, 125, 150, Inf)
```

## Data

```{r}
files <- list.files("predictions", pattern = ".rds", full.names = T)
```


## Plot predict

```{r}
pdf(file = "results/ts_forecast.pdf", w = 21 / cm(1), h = 14 / cm(1))
for (f in files) {
  ctry <- gsub(".rds", "", basename(f))
  n_ahead <- 10
  print(
    read_files(f) %>%
      get_max_N() %>%
      dplyr::filter(max_N >= n_ahead) %>%
      rowwise() %>%
      mutate_at(vars(arima, cori, prophet), ~ list(.[n_ahead, ])) %>% 
      mutate_at(vars(date, new_confirmed), ~ list(.[n_ahead])) %>% 
      unnest(cols = c("date", "new_confirmed", "arima", "cori", "prophet")) %>%
      mutate(target = new_confirmed / population * 1e5) %>%
      mutate_at(vars(arima, cori, prophet), ~ . / population * 1e5) %>%
      dplyr::select(date, target, arima, cori, prophet) %>%
      reshape2::melt(c("date")) %>%
      plot_predict(interval = T) +
      labs(y = "Incidence (per 100,000 population)", 
           color = "CrI", fill = "CrI",
           title = ctry, 
           subtitle = paste0("Probabilistic ", n_ahead, "-day ahead forecast (blue) for daily new cases (black)")) 
  )
  
  print(
    read_files(f) %>%
      rowwise() %>%
      mutate_at(vars(arima, cori, prophet), ~ list(apply(., 1, mean))) %>%
      unnest(cols = c("date", "new_confirmed", "n", "arima", "cori", "prophet")) %>%
      dplyr::filter(n %in% c(1, 7, 14, 21)) %>%
      mutate(n = factor(as.character(n), levels = c("1", "7", "14", "21"))) %>%
      mutate(target = new_confirmed / population * 1e5) %>%
      mutate_at(vars(arima, cori, prophet), ~ . / population * 1e5) %>%
      dplyr::select(id, date, target, n, arima, cori, prophet) %>%
      reshape2::melt(c("id", "date", "n")) %>%
      plot_predict(interval = F) +
      labs(y = "Incidence (per 100,000 population)",
           color = "Number of days forecasted ahead",
           title = ctry, 
           subtitle = "Posterior mean N-days ahead forecast (color) for daily new cases (black)")
  )
}
dev.off()
```


## Calibration

### Probabilistic

```{r}
df_pCalib <- do.call(rbind, map(files, function(f) {
  print(sprintf("Processing file %s", f))
  read_files(f) %>%
    dplyr::select(id, population, new_confirmed, date, n, arima, prophet, cori) %>%
    rowwise() %>%
    mutate_at(vars(arima, cori, prophet), ~ pred_score(., y = new_confirmed, type = "calibration")) %>%
    unnest(cols = c("n", "date", "new_confirmed", "arima", "cori", "prophet"))
}))

pCalib_pl <- df_pCalib %>%
  mutate(n = cut(n, breaks = n_brks, labels = n_lbs)) %>%
  dplyr::select(n, arima, cori, prophet) %>%
  reshape2::melt("n") %>%
  ggplot(aes(x = value)) +
  facet_wrap(~ variable + n, ncol = 3) +
  geom_histogram(aes(y = stat(count) / sum(count))) +
  scale_y_continuous(labels = function(x) x * 100) +
  labs(x = "Probability integral transform", 
       y = "Relative frequency (%)",
       title = "Probabilistic Calibration",
       subtitle = "PIT histogram by method and weekly ahead forecast") +
  theme_bw2()

save_plot(pCalib_pl, "results/calibration_probabilistic.pdf", w = 21, h = 21)
```


### Marginal

```{r}
Gx <- df_pCalib %>%
  group_by(id, date) %>% 
  summarize(incidence = new_confirmed[1] / population * 1e5) %>%
  ungroup() %>%
  group_by(id) %>%
  mutate(Gx = ecdf(.$incidence)(incidence)) %>%
  ungroup() 

df_mCalib <- df_pCalib %>%
  left_join(Gx) %>%
  mutate_at(vars(arima, cori, prophet), ~ . - Gx) %>%
  mutate(incidence = as.numeric(as.character(cut(incidence, breaks = inc_small_brks, labels = inc_small_brks[-1])))) %>%
  dplyr::select(n, incidence, arima, cori, prophet) %>%
  mutate(n = cut(n, breaks = n_brks, labels = n_lbs)) %>%
  reshape2::melt(c("n", "incidence")) %>%
  group_by(n, incidence, variable) %>%
  summarize(value = mean(value)) %>%
  ungroup() 

mCalib_pl <- df_mCalib %>%
  ggplot(aes(x = incidence, y = value, color = variable)) +
  geom_line() +
  facet_wrap(~ n, ncol = 3) +
  geom_hline(aes(yintercept = 0), linetype = "dotted") +
  scale_color_brewer(palette = "Dark2") +
  scale_x_continuous(breaks = inc_small_brks) +
  labs(x = "Threshold of incidence (new cases per 100,000 people)", 
       y = "Average predictive CDF - Average empirical CDF",
       title = "Probabilistic Calibration",
       subtitle = "PIT histogram by method and N-day ahead forecast") +
  theme_bw2() +
  theme(legend.position = "top", 
        legend.title = element_blank(),
        legend.justification = "left") 

save_plot(mCalib_pl, "results/calibration_marginal.pdf", w = 21, h = 10)
```


## Sharpness

```{r}
df_sharp <- do.call(rbind, map(files, function(f) {
  print(sprintf("Processing file %s", f))
  read_files(f) %>%
    dplyr::select(id, new_confirmed, date, n, arima, prophet, cori, population) %>%
    rowwise() %>%
    mutate_at(vars(arima, cori, prophet), list(Q50 = ~ pred_score(., new_confirmed / population * 1e5, type = "sharpness", q = 0.25))) %>%
    mutate_at(vars(arima, cori, prophet), list(Q90 = ~ pred_score(., new_confirmed / population * 1e5, type = "sharpness", q = 0.05))) %>%
    dplyr::select(-arima, -cori, -prophet) %>%
    unnest(cols = c("n", "date", "new_confirmed", "arima_Q50", "cori_Q50", "prophet_Q50", "arima_Q90", "cori_Q90", "prophet_Q90"))
}))

sharp_pl <- df_sharp %>%
  mutate(n = cut(n, breaks = n_brks, labels = n_lbs)) %>%
  dplyr::select(-population, -new_confirmed) %>%
  reshape2::melt(c("id", "n", "date")) %>%
  mutate(cri = factor(stringi::stri_extract(variable, regex = "Q\\d{2}"), levels = c("Q50", "Q90"))) %>%
  mutate(variable = factor(gsub("_Q\\d{2}", "", variable), levels = c("arima", "cori", "prophet"))) %>%
  ggplot(aes(x = cri, y = value)) +
  facet_wrap(~ variable + n, ncol = length(n_brks)-1) +
  geom_boxplot() +
  labs(x = "Q%-Credible interval", 
       y = "Size of interval (incidence)",
       title = "Sharpness",
       subtitle = "Size of Q%-credible interval by method and N-day ahead forecast") +
  theme_bw2()

save_plot(sharp_pl, "results/sharpness.pdf", w = 21, h = 21)
```


## CRPS

```{r}
df_ps <- do.call(rbind, map(files, function(f) {
  print(sprintf("Processing file %s", f))
  read_files(f) %>%
    rowwise() %>%
    mutate_at(vars(arima, cori, prophet), ~ pred_score(., new_confirmed, type = "crps")) %>%
    unnest(cols = c("n", "date", "new_confirmed", "arima", "cori", "prophet"))
}))
```


### By N

```{r}
crps_by_n_pl <- df_ps %>%
  mutate(group = cut(n, breaks = c(0, 5, 10, 15, 21), 
                     labels = paste(c("short (0-5", "medium (6-10", "long (11-15", "very long (15-21"), " days) forecast", sep = " "))) %>%
  dplyr::select(id, group, arima, cori, prophet) %>%
  reshape2::melt(c("id", "group")) %>%
  plot_score(x = "CRPS", y = "Method") +
  labs(title = "Skill",
       subtitle = "CRPS by method and length of forecast") +
  theme_bw2()

save_plot(crps_by_n_pl, "results/crps_by_n.pdf", w = 21, h = 14)
```


## Weighted CRPS

```{r}
WM <- data_delay(30, T, p_in, mu = rnorm(1e4, 10.92, 0.94), sigma = rnorm(1e4, 5.41, 0.27))
w <- WM %>%
  group_by(x) %>%
  summarize(mean_weight = mean(value)) %>%
  dplyr::select(mean_weight) %>%
  unlist()

plot(w, xlab = "Days ahead", ylab = "Weight", type = "b")

df_ps_weighted <- df_ps %>%
  rowwise() %>%
  mutate_at(vars(arima, cori, prophet), ~ . * w[n]) 
```

### By ID

```{r}
weighted_crps_by_id_pl <- df_ps_weighted %>%
  dplyr::select(id, arima, cori, prophet) %>%
  reshape2::melt(c("id")) %>% 
  rename(group = id) %>%
  plot_score(x = "Weighted CRPS", y = "Method") +
  labs(title = "Skill",
       subtitle = "Weighted CRPS by country") +
  theme_bw2()

save_plot(weighted_crps_by_id_pl, "results/crps_weighted_by_id.pdf", w = 21, h = 21)
```

### By incidence

```{r}
weighted_crps_inc_pl <- df_ps_weighted %>%
  mutate(incidence = new_confirmed / population * 1e5) %>%
  mutate(group = cut(incidence, breaks = c(-Inf, 30, 50, 100, Inf), 
                     labels = paste(c("low", "medium", "high", "very high"), "incidence", sep = " "))) %>%
  dplyr::select(id, group, arima, cori, prophet) %>%
  reshape2::melt(c("id", "group")) %>%
  plot_score(x = "Weighted CRPS", y = "Method") +
  labs(title = "Skill",
       subtitle = "Weighted CRPS by incidence (new cases per 100,000 people)") +
  theme_bw2()

save_plot(weighted_crps_inc_pl, "results/crps_weighted_by_incidence.pdf", w = 21, h = 14)
```



## Policy metric

### TPP and FPP

```{r}
df_crit <- do.call(rbind, map(files[1], function(f) {
  print(sprintf("Processing file %s", f))
  read_files(f) %>%
    dplyr::select(id, new_confirmed, date, n, arima, prophet, cori, population) %>%
    rowwise() %>%
    mutate_at(vars(arima, cori, prophet), list(Q25 = ~ pred_score(. / population * 1e5, type = "critical", q = 25))) %>%
    mutate_at(vars(arima, cori, prophet), list(Q50 = ~ pred_score(./ population * 1e5, type = "critical", q = 50))) %>%
    mutate_at(vars(arima, cori, prophet), list(Q75 = ~ pred_score(. / population * 1e5, type = "critical", q = 75))) %>%
    mutate_at(vars(arima, cori, prophet), list(Q100 = ~ pred_score(. / population * 1e5, type = "critical", q = 100))) %>%
    dplyr::select(-arima, -cori, -prophet) %>%
    unnest(cols = c("n", "date", "new_confirmed", 
                    "arima_Q25", "cori_Q25", "prophet_Q25", "arima_Q50", "cori_Q50", "prophet_Q50",
                    "arima_Q75", "cori_Q75", "prophet_Q75", "arima_Q100", "cori_Q100", "prophet_Q100"))
}))

df_crit_weight <- df_crit %>%
  reshape2::melt(c("n", "id", "date", "new_confirmed", "population")) %>%
  mutate(threshold = as.numeric(stringi::stri_extract(variable, regex = "\\d{2,3}"))) %>%
  mutate(variable = gsub("_Q\\d{2,3}", "", variable)) %>%
  mutate(value = value * w[n]) %>%
  group_by(id, date, threshold, variable, new_confirmed, population) %>%
  summarize(value = sum(value)) %>%
  ungroup()

# subset critical values
df_crit_weight_sub <- df_crit_weight %>%
  group_by(id, variable, threshold) %>%
  arrange(date) %>%
  mutate(is_crit = is_critical(new_confirmed / population * 1e5, threshold[1], min_x = 10)) %>%
  ungroup() %>%
  dplyr::filter(!is.na(is_crit))

weighted_tpp_pl <- df_crit_weight_sub %>%
  dplyr::filter(is_crit == "up") %>%
  rename(group = threshold) %>%
  plot_score() +
  scale_x_continuous(limits = c(0, 1), expand = c(0,0), labels = function(x) x * 100) +
  labs(x = "Weighted true positive probability (TPP)", 
       y = "Method",
       title = "Critical Incidence",
       subtitle = "Weighted TPP by critical incidence") +
  theme_bw2()

weighted_tpp_pl


weighted_fpp_pl <- df_crit_weight_sub %>%
  dplyr::filter(is_crit == "down") %>%
  rename(group = threshold) %>%
  plot_score() +
  scale_x_continuous(limits = c(0, 1), expand = c(0,0), labels = function(x) x * 100) +
  labs(x = "Weighted false positive probability (%)", 
       y = "Method",
       title = "Critical incidence",
       subtitle = "Weighted FPP by critical incidence") +
  theme_bw2()

weighted_fpp_pl

df_crit_weight_f1 <- df_crit_weight_sub %>%
  group_by(id, variable, is_crit, threshold) %>%
  summarize(value = mean(value)) %>%
  reshape2::dcast(id + variable + threshold ~ is_crit) %>%
  mutate(f1 = up / (up + 0.5 * (down + (1-up))))

weighted_f1_pl <- df_crit_weight_f1 %>%
  rename(group = threshold, value = f1) %>%
  plot_score() +
  scale_x_continuous(limits = c(0, 1), expand = c(0,0), labels = function(x) x * 100) +
  labs(x = "F1 (%)", 
       y = "Method",
       title = "Critical incidence",
       subtitle = "Weighted F1-score by critical incidence",
       caption = "Note: TPP and FPP are summarized by ID and then F1 is computed.") +
  theme_bw2()

weighted_f1_pl

critical_pl <- arrangeGrob(weighted_tpp_pl, weighted_fpp_pl, weighted_f1_pl, ncol = 2)

save_plot(critical_pl, "results/critical_incidence.pdf", w = 21, h = 18)
```

### Peak delay

```{r}
df_peak <- do.call(rbind, map(files, function(f) {
  print(sprintf("Processing file %s", f))
  df <- read_files(f) %>%
    dplyr::select(id, population, new_confirmed, date, n, arima, prophet, cori) %>%
    rowwise() %>%
    mutate_at(vars(arima, cori, prophet), ~ list(apply(., 1, mean))) %>%
    unnest(cols = c("n", "date", "new_confirmed", "arima", "cori", "prophet")) %>%
    mutate_at(vars(new_confirmed, arima, cori, prophet), ~ . / population * 1e5) %>%
    dplyr::select(id, date, n, new_confirmed, arima, cori, prophet) 
  
  df %>%
    group_by(id, n) %>%
    nest() %>%
    mutate(data = map(data, ~ mutate(.x, peak = is_peak(new_confirmed, min_x = 15)))) %>%
    mutate(data = map(data, ~ mutate_at(.x, vars(arima, cori, prophet), list(peak = ~ is_closest_peak(., peak, t_right = Inf))))) %>%
    mutate(data_peak = map(data, function(D) {
      pd <- data.frame(cbind.fill(
        (D$date[D$peak]),
        (D$date[D$arima_peak]),
        (D$date[D$cori_peak]),
        (D$date[D$prophet_peak]),
        (D$new_confirmed[D$peak]),
        (D$arima[D$arima_peak]),
        (D$cori[D$cori_peak]),
        (D$prophet[D$prophet_peak])
      ), stringsAsFactors = F) %>%
        set_names(c("obs_date", "arima_date", "cori_date", "prophet_date",
                    "obs_inc", "arima_inc", "cori_inc", "prophet_inc")) %>%
        mutate_at(vars(matches("date")), as.Date, origin = "1970-01-01") %>%
        mutate_at(vars(matches("inc")), as.numeric)
      return(pd)
    })) %>%
    dplyr::select(id, n, data_peak) %>%
    unnest(cols = "data_peak") %>%
    group_by(id, n) %>%
    mutate(peak_no = 1:n()) %>%
    ungroup()
}))

# nuber of peaks by country
df_peak %>% 
  group_by(id) %>%
  summarize(max(peak_no)) 

peak_delay <- df_peak %>%
  group_by(id) %>%
  dplyr::filter(obs_inc == max(obs_inc)) %>% # use maximum peak for now
  mutate_at(vars(arima_date, cori_date, prophet_date), list(ddiff = ~ n - as.numeric(. - obs_date))) 
  
peak_delay_pl <- peak_delay %>%
  mutate(n = cut(n, breaks = n_brks, labels = n_lbs)) %>%
  dplyr::select(id, n, matches("ddiff")) %>%
  melt(c("id", "n")) %>%
  mutate(variable = gsub("_date_ddiff", "", variable)) %>%
  rename(group = n) %>%
  plot_score(CrI = c(0.5, 0.8)) +
  geom_vline(aes(xintercept = 0), linetype = "dotted") +
  labs(x = "Predicted days ahead - (method peak - observed peak)", 
       y = "Method",
       title = "Peak delay",
       subtitle = "Peak delay by method and weekly ahead forecast",
       caption = "Note: Data summarized by the highest peak of each country.") +
  theme_bw2()

save_plot(peak_delay_pl, "results/peak_delay.pdf", w = 21, h = 18)
```





