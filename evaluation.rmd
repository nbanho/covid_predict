---
title: "Evaluation"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
# libraries
library(tidyverse)
library(reshape2)
library(lubridate)
library(grid)
library(gridExtra)
library(covidcast)

# utils
source("utils/eval.r")
source("utils/delays.r")

# helper
source("helper/plotting.r")
```

## Data

```{r}
# files
files <- list.files("predictions", pattern = ".rds", full.names = T)

# models
models <- c("cori", "arima", "prophet", "gp")

# parameters
# - model colors
mcols <- RColorBrewer::brewer.pal(length(models), "Dark2")
# - discretize forecast weeks
n_brks <- c(0, 7, 14, 21)
n_lbs <- paste(c("1", "2", "3"), "-week(s) ahead forecast", sep = " ")
# - discretize incidence
inc_small_brks <- c(-Inf, 10, 20, 30, 40, 50, 60, 80, 100, 125, 150, Inf)
# - default ahead forecast to look at
n_ahead <- 10
```


## Plot forecast

### By model and country

```{r}
pdf(file = "results/ts_forecast.pdf", w = 21 / cm(1), h = 14 / cm(1))
for (f in files) {
  ctry <- gsub(".rds", "", basename(f))
  print(
    read_files(f) %>%
      lapply(., function(X) X[n_ahead, ]) %>%
      lapply(., function(X) mutate_at(X, vars(models), ~ list(c(.)))) %>%
      do.call(rbind, .) %>%
      unnest(cols = models) %>%
      comp_inc(cori) %>%
      rename(target = inc, date = test_date) %>%
      dplyr::select(date, target, models) %>%
      melt(c("date")) %>%
      plot_predict(interval = T) +
      scale_y_continuous(limits = c(0, 300)) +
      labs(y = "Incidence (per 100,000 population)", 
           color = "CrI", fill = "CrI",
           title = ctry, 
           subtitle = paste0("Probabilistic ", n_ahead, "-day ahead forecast (blue) for daily new cases (black)")) 
  )
  
  print(
    read_files(f) %>%
      lapply(., function(X) mutate_at(X, vars(models), ~ apply(., 1, mean))) %>%
      do.call(rbind, .) %>%
      add_n_ahead() %>%
      dplyr::filter(n %in% c(1, 7, 14, 21)) %>%
      mutate(n = factor(as.character(n), levels = c("1", "7", "14", "21"))) %>%
      comp_inc(cori) %>%
      rename(target = inc, date = test_date) %>%
      dplyr::select(date, target, n, models) %>%
      reshape2::melt(c("date", "n")) %>%
      plot_predict(interval = F) +
      scale_y_continuous(limits = c(0, 300)) +
      labs(y = "Incidence (per 100,000 population)",
           color = "Number of days forecasted ahead",
           title = ctry, 
           subtitle = "Posterior mean N-days ahead forecast (color) for daily new cases (black)")
  )
}
dev.off()
```


### Average-7d by country

```{r}
mean10 <- do.call(rbind, lapply(files, function(f) {
  read_files(f) %>%
    lapply(., function(X) mutate_at(X, vars(models), ~ apply(., 1, mean))) %>%
    do.call(rbind, .) %>%
    add_n_ahead() %>%
    dplyr::filter(n == n_ahead) %>%
    comp_inc(cori) %>%
    rename(target = inc, date = test_date, id = state_id) %>%
    dplyr::select(id, date, target, models) %>%
    melt(measure.vars = c("target", models)) %>%
    group_by(id, variable) %>%
    mutate(value = zoo::rollmean(value, k = 7, fill = NA, align = "right")) %>%
    ungroup() %>%
    na.omit()
}))

mean10_pl <- ggplot(mean10, mapping = aes(x = date, y = value, color = variable)) +
  facet_wrap(~ id, ncol = 3, scales = "free_x") +
  geom_line(alpha = .5) +
  scale_color_manual(values = c("black", mcols)) +
  scale_y_continuous(limits = c(0, 300), expand = c(0,0)) +
  scale_x_date(date_breaks = "1 month") +
  theme_bw2() +
  theme(axis.title.x = element_blank(), legend.position = "top",
        axis.text.x = element_text(angle = 90)) +
  labs(y = "Incidence (per 100,000 population)", 
       color = "Model forecast",
       title = "Mean forecast by model", 
       subtitle = paste0("Mean Probabilistic ", n_ahead, "-day ahead forecast (color) for daily new cases (dark)")) 

mean10_pl

save_plot(mean10_pl, "results/ts_mean10.pdf", w = 21, h = 28)
```



## Calibration

### Probabilistic

```{r}
df_pCalib <- do.call(rbind, map(files, function(f) {
  print(sprintf("Processing file %s", f))
  read_files(f) %>%
    lapply(., function(X) comp_inc(X, cori)) %>%
    lapply(., function(X) cbind(dplyr::select(X, state_id, forecast_date, test_date, inc), 
                                sapply(models, function(m) pred_score(X[[m]], X$inc, type = "calibration")))) %>%
    do.call(rbind, .)
}))

pCalib_pl <- df_pCalib %>%
  add_n_ahead() %>%
  mutate(n = cut(n, breaks = n_brks, labels = n_lbs)) %>%
  dplyr::select(n, models) %>%
  reshape2::melt("n") %>%
  ggplot(aes(x = value)) +
  facet_wrap(~ variable + n, ncol = 3) +
  geom_histogram(aes(y = stat(count) / sum(count))) +
  scale_y_continuous(labels = function(x) x * 100) +
  labs(x = "Probability integral transform", 
       y = "Relative frequency (%)",
       title = "Probabilistic Calibration",
       subtitle = "PIT histogram by method and weekly ahead forecast") +
  theme_bw2()

pCalib_pl

save_plot(pCalib_pl, "results/calibration_probabilistic.pdf", w = 21, h = 21)
```


### Marginal

```{r}
Gx <- df_pCalib %>%
  group_by(state_id, test_date) %>% 
  slice(1) %>%
  ungroup() %>%
  group_by(state_id) %>%
  mutate(Gx = ecdf(.$inc)(inc)) %>%
  ungroup() 

df_mCalib <- df_pCalib %>%
  left_join(Gx) %>%
  mutate_at(vars(models), ~ . - Gx) %>%
  mutate(incidence = as.numeric(as.character(cut(incidence, breaks = inc_small_brks, labels = inc_small_brks[-1])))) %>%
  dplyr::select(n, incidence, models) %>%
  mutate(n = cut(n, breaks = n_brks, labels = n_lbs)) %>%
  reshape2::melt(c("n", "incidence")) %>%
  group_by(n, incidence, variable) %>%
  summarize(value = mean(value)) %>%
  ungroup() 

mCalib_pl <- df_mCalib %>%
  ggplot(aes(x = incidence, y = value, color = variable)) +
  geom_line() +
  facet_wrap(~ n, ncol = 3) +
  geom_hline(aes(yintercept = 0), linetype = "dotted") +
  scale_color_brewer(palette = "Dark2") +
  scale_x_continuous(breaks = inc_small_brks) +
  labs(x = "Threshold of incidence (new cases per 100,000 people)", 
       y = "Average predictive CDF - Average empirical CDF",
       title = "Probabilistic Calibration",
       subtitle = "PIT histogram by method and N-day ahead forecast") +
  theme_bw2() +
  theme(legend.position = "top", 
        legend.title = element_blank(),
        legend.justification = "left") 

save_plot(mCalib_pl, "results/calibration_marginal.pdf", w = 21, h = 10)
```


## Sharpness

```{r}
df_sharp <- do.call(rbind, map(files, function(f) {
  print(sprintf("Processing file %s", f))
  read_files(f) %>%
    lapply(., function(X) comp_inc(X, cori)) %>%
    lapply(., function(X) cbind(dplyr::select(X, state_id, forecast_date, test_date, inc), 
                                sapply(models, function(m) pred_score(X[[m]], X$inc, type = "sharpness", q = .25)) %>% 
                                  set_names(paste0(models, "_Q50")),
                                sapply(models, function(m) pred_score(X[[m]], X$inc, type = "sharpness", q = .05)) %>% 
                                  set_names(paste0(models, "_Q90")))) %>%
    do.call(rbind, .)
}))

sharp_pl <- df_sharp %>%
  add_n_ahead() %>%
  mutate(n = cut(n, breaks = n_brks, labels = n_lbs)) %>%
  dplyr::select(-forecast_date, -test_date, -inc) %>%
  melt(c("state_id", "n")) %>%
  mutate(cri = factor(stringi::stri_extract(variable, regex = "Q\\d{2}"), levels = c("Q50", "Q90"))) %>%
  mutate(variable = factor(gsub("_Q\\d{2}", "", variable), levels = models)) %>%
  ggplot(aes(x = cri, y = value)) +
  facet_wrap(~ variable + n, ncol = length(n_brks)-1) +
  geom_boxplot() +
  labs(x = "Q%-Credible interval", 
       y = "Size of interval (incidence)",
       title = "Sharpness",
       subtitle = "Size of Q%-credible interval by method and N-day ahead forecast") +
  theme_bw2()

sharp_pl

save_plot(sharp_pl, "results/sharpness.pdf", w = 21, h = 21)
```


## CRPS

```{r}
df_ps <- do.call(rbind, map(files, function(f) {
  print(sprintf("Processing file %s", f))
  read_files(f) %>% add_pred_score(models = models, type = "crps")
}))

crps_pl <- df_ps %>%
  plot_score(models = models, model_colors = mcols) +
  labs(y = "Score", x = "Models",
       title = "CRPS",
       subtitle = "Boxplot of average country scores") +
  theme_bw2()

crps_pl

save_plot(crps_pl, "results/crps.pdf", w = 21, h = 14)
```

### Censored

```{r}
df_cens_ps <- do.call(rbind, map(files, function(f) {
  print(sprintf("Processing file %s", f))
  read_files(f) %>% add_pred_score(models = models, type = "crps", trans = function(x) {x[x>300] <- 300; return(x)})
}))

cens_crps_pl <- df_cens_ps %>%
  plot_score(models = models, model_colors = mcols) +
  labs(y = "Score", x = "Models",
       title = "Censored CRPS",
       subtitle = "Boxplot of average country scores") +
  theme_bw2()

cens_crps_pl

save_plot(cens_crps_pl, "results/censored_crps.pdf", w = 21, h = 14)
```

#### By N

```{r}
crps_by_n_pl <- df_cens_ps %>%
  add_n_ahead() %>%
  mutate(group = cut(n, breaks = n_brks, labels = n_lbs)) %>%
  plot_score(models = models, model_colors = mcols) +
  labs(y = "Score", x = "Model",
       title = "CRPS",
       subtitle = "Boxplot of average country scores by n-day ahead forecast") +
  theme_bw2()

crps_by_n_pl

save_plot(crps_by_n_pl, "results/crps_by_n.pdf", w = 21, h = 14)
```

#### By phase

```{r}
phases <- read_csv("predictions/phase-labeling.csv")

which_phase <- function(id, date) {
  sub <- phases %>%
    dplyr::filter(state == id) %>%
    dplyr::filter(date > start) %>%
    dplyr::filter(date <= end)
  return(sub$label)
}
  
crps_by_phase <- df_cens_ps %>%
  add_n_ahead() %>%
  rowwise() %>%
  mutate(phase = which_phase(state_id, test_date))

crps_by_phase_pl <- crps_by_phase %>%
  dplyr::select(c("n", "phase", models)) %>%
  melt(c("n", "phase")) %>%
  group_by(n, phase, variable) %>%
  summarize(mean_score = mean(value)) %>%
  ungroup() %>%
  mutate(variable = factor(variable, levels = models)) %>%
  mutate(phase = ifelse(phase == "I", "Increase", 
                        ifelse(phase == "D", "Decrease", 
                               ifelse(phase == "F", "Flat", "Peak-change")))) %>%
  mutate(phase = factor(phase, levels = c("Increase", "Peak-change", "Decrease", "Flat"))) %>%
  ggplot(aes(x = n, y = mean_score, color = variable)) +
  facet_wrap(~ phase) +
  geom_line() +
  scale_y_continuous(expand = c(0,0), limits = c(0, NA)) +
  scale_color_manual(values = mcols) +
  labs(y = "Score", x = "Number of days forecasted ahead",
       title = "CRPS by epidemic phase",
       subtitle = "Average CRPS by phase from five US states (AK, AL, AR, AZ, CA)") +
  theme_bw2() 
  

crps_by_phase_pl

save_plot(crps_by_phase_pl, "results/crps_by_phase.pdf", w = 21, h = 14)
```

### Weighted

```{r}
WM <- data_delay(30, T, p_in, mu = rnorm(1e4, 10.92, 0.94), sigma = rnorm(1e4, 5.41, 0.27))
w <- WM %>%
  group_by(x) %>%
  summarize(mean_weight = mean(value)) %>%
  dplyr::select(mean_weight) %>%
  unlist()

plot(w, xlab = "Days ahead", ylab = "Weight", type = "b")

df_ps_weighted <- df_cens_ps %>%
  add_n_ahead() %>%
  mutate_at(vars(models), ~ . * w[n]) %>%
  group_by(state_id, forecast_date) %>%
  summarize_at(vars(models), ~ sum(.)) %>%
  ungroup()

crps_weighted_pl <- df_ps_weighted %>%
  plot_score(models = models, model_colors = mcols) +
  theme_bw2() +
  labs(y = "Score", x = "Model",
       title = "Censored weighted CRPS",
       subtitle = "Boxplot of average country scores") 
  
crps_weighted_pl

save_plot(crps_weighted_pl, "results/weighted_crps.pdf", w = 21, h = 14)
```

### Asymmetry 

```{r}
bias_weight <- function(p) {
  p <- p - 0.5
  if (p <= 0) {
    (1 - p) ^ 2
  } else {
    (1 + p) ^ 1
  }
}

plot(x = seq(0, 1, .01), y = 1 * sapply(seq(0, 1, .01), bias_weight), type = "b")

df_pb <- do.call(rbind, map(files, function(f) {
  print(sprintf("Processing file %s", f))
  read_files(f) %>% add_pred_score(models = models, type = "bias")
}))

df_cens_ps_pb <- df_cens_ps
df_cens_ps_pb[ ,models] <- df_cens_ps_pb[ ,models] * apply(df_pb[ ,models], c(1,2), bias_weight)
df_cens_ps_pb_weighted <- df_cens_ps_pb %>%
  add_n_ahead() %>%
  mutate_at(vars(models), ~ . * w[n]) %>%
  group_by(state_id, forecast_date) %>%
  summarize_at(vars(models), ~ sum(.)) %>%
  ungroup()

crps_asym_pl <- df_cens_ps_pb_weighted %>%
  plot_score(models = models, model_colors = mcols) +
  labs(y = "Score", x = "Model",
       title = "Censored weighted asymmetric CRPS",
       subtitle = "Boxplot of average country scores") +
  theme_bw2()

crps_asym_pl

save_plot(crps_asym_pl, "results/crps_weighted_asym.pdf", w = 21, h = 14)
```

```{r}
all_crps_pl <- grid.arrange(crps_pl, cens_crps_pl, crps_weighted_pl, crps_asym_pl, ncol = 2)
save_plot(all_crps_pl, "results/crps_comparison.pdf", w = 20, h = 20)
save_plot(all_crps_pl, "results/crps_comparison.png", w = 20, h = 12)
```


<!-- ## Regret -->

<!-- ```{r} -->
<!-- df_rr <- do.call(rbind, map(files, function(f) { -->
<!--   print(sprintf("Processing file %s", f)) -->
<!--   read_files(f) %>% -->
<!--     rowwise() %>% -->
<!--     mutate_at(vars(models), ~ regret_score(., new_confirmed, pop = population[1], w = w, b = .5)) %>% -->
<!--     unnest(cols = c("n", "date", "new_confirmed", models)) -->
<!-- })) -->
<!-- ``` -->

<!-- ### Overall -->

<!-- ```{r} -->
<!-- regret_pl <- df_rr %>% -->
<!--   dplyr::select(id, models) %>% -->
<!--   reshape2::melt(c("id")) %>% -->
<!--   group_by(variable) %>% -->
<!--   summarize(m = median(value), -->
<!--             q1 = quantile(value, .25), -->
<!--             q3 = quantile(value, .75)) %>% -->
<!--   ungroup() %>% -->
<!--   ggplot(aes(x = variable)) + -->
<!--   geom_point(aes(y = m)) + -->
<!--   geom_errorbar(aes(ymin = q1, ymax = q3), width = .1) + -->
<!--   theme_bw2() + -->
<!--   theme(axis.title.x = element_blank()) + -->
<!--   labs(y = "Regret score (Median and IQR)", x = "", -->
<!--        title = "Regret", -->
<!--        subtitle = "Regret score by method and length of forecast") + -->
<!--   theme_bw2() -->

<!-- regret_pl -->

<!-- save_plot(regret_pl, "results/regret.pdf", w = 21, h = 14) -->
<!-- ``` -->

<!-- ### By ID -->

<!-- ```{r} -->
<!-- regret_by_id_pl <- df_rr %>% -->
<!--   dplyr::select(id, models) %>% -->
<!--   reshape2::melt(c("id")) %>% -->
<!--   group_by(id, variable) %>% -->
<!--   summarize(m = median(value)) %>% -->
<!--   ungroup() %>% -->
<!--   ggplot(aes(x = id, y = m, fill = variable)) + -->
<!--   geom_bar(stat = "identity", position = position_dodge()) + -->
<!--   scale_fill_manual(values = mcols) + -->
<!--   theme_bw2() + -->
<!--   theme(axis.title.x = element_blank(), legend.title = element_blank()) + -->
<!--   labs(y = "Regret score (Median)", x = "", -->
<!--        title = "Regret", -->
<!--        subtitle = "Regret score by method and country")  -->

<!-- regret_by_id_pl -->

<!-- save_plot(regret_by_id_pl, "results/regret_by_id.pdf", w = 21, h = 14) -->
<!-- ``` -->


<!-- ### By incidence -->

<!-- ```{r} -->
<!-- regret_by_inc_pl <- df_rr %>% -->
<!--   mutate(incidence = trans(new_confirmed, pop = population, transfct = NULL)) %>% -->
<!--   mutate(group = cut(incidence, breaks = c(-Inf, 30, 50, 100, Inf),  -->
<!--                      labels = paste(c("low", "medium", "high", "very high"), "incidence", sep = " "))) %>% -->
<!--   dplyr::select(id, group, models) %>% -->
<!--   reshape2::melt(c("id", "group")) %>% -->
<!--   plot_score() + -->
<!--   labs(y = "CRPS (Median and IQR)", x = "", -->
<!--        title = "Skill", -->
<!--        subtitle = "CRPS by method and incidence") + -->
<!--   theme_bw2() -->

<!-- regret_by_inc_pl -->

<!-- save_plot(regret_by_inc_pl, "results/regret_by_inc.pdf", w = 21, h = 14) -->
<!-- ``` -->

## Hotspot 

```{r}
df_hot <- do.call(rbind, map(files, function(f) {
  # read file
  print(sprintf("Processing file %s", f))
  df <- read_files(f) 
  
  # compute hotspot probabilities and create list from matrix
  prob_hot <- lapply(models, function(m) {
    P <- sapply(df, function(X) p_hotspot(X[[m]])) 
    lapply(seq_len(ncol(P)), function(i) P[ ,i]) })
  names(prob_hot) <- models
  
  # determine true (if hotspot) and create list from matrix
  hot <- sapply(df, function(X) is_hotspot(X$inc))
  prob_hot$hot <- lapply(seq_len(ncol(hot)), function(i) hot[ ,i])
  
  # add state_id and n to list
  prob_hot$n <- lapply(1:length(df), function(x) 1:nrow(hot) + 7)
  prob_hot$state_id <- df[[1]]$state_id[1]
  
  # combine to long dataframe
  prob_hot <- unnest(as_data_frame(prob_hot), c("n", "hot", models)) 
}))

df_hot_pl <- df_hot %>%
  filter(!is.na(hot)) %>%
  melt(c("n", "hot", "state_id")) %>%
  group_by(n, variable) %>%
  summarize(AUC = auc(hot, value)[1]) %>%
  ungroup() %>%
  mutate(variable = factor(variable, levels = models)) %>%
  ggplot(aes(x = n, y = AUC, color = variable, shape = variable)) +
  geom_point() +
  geom_line() +
  geom_hline(aes(yintercept = 0.5), linetype = "dashed") +
  scale_color_manual(values = mcols) +
  labs(x = "Number of days forecasted ahead", 
       y = "AUC for hotspot dates (%)", 
       color = "Model", shape = "Model",
       title = "Hotspot",
       subtitle = "AUC for forecasting hotspots (25% weekly increase in incidence)") +
  theme_bw2() +
  theme(legend.position = "top")
  
df_hot_pl

save_plot(df_hot_pl, "results/hotspot.pdf", w = 20, h = 14)
save_plot(df_hot_pl, "results/hotspot.png", w = 20, h = 12)
```

<!-- ### TPP and FPP -->

<!-- ```{r} -->
<!-- df_crit <- do.call(rbind, map(files[1], function(f) { -->
<!--   print(sprintf("Processing file %s", f)) -->
<!--   read_files(f) %>% -->
<!--     dplyr::select(id, new_confirmed, date, n, arima, prophet, cori, population) %>% -->
<!--     rowwise() %>% -->
<!--     mutate_at(vars(arima, cori, prophet), list(Q25 = ~ pred_score(. / population * 1e5, type = "critical", q = 25))) %>% -->
<!--     mutate_at(vars(arima, cori, prophet), list(Q50 = ~ pred_score(./ population * 1e5, type = "critical", q = 50))) %>% -->
<!--     mutate_at(vars(arima, cori, prophet), list(Q75 = ~ pred_score(. / population * 1e5, type = "critical", q = 75))) %>% -->
<!--     mutate_at(vars(arima, cori, prophet), list(Q100 = ~ pred_score(. / population * 1e5, type = "critical", q = 100))) %>% -->
<!--     dplyr::select(-arima, -cori, -prophet) %>% -->
<!--     unnest(cols = c("n", "date", "new_confirmed",  -->
<!--                     "arima_Q25", "cori_Q25", "prophet_Q25", "arima_Q50", "cori_Q50", "prophet_Q50", -->
<!--                     "arima_Q75", "cori_Q75", "prophet_Q75", "arima_Q100", "cori_Q100", "prophet_Q100")) -->
<!-- })) -->

<!-- df_crit_weight <- df_crit %>% -->
<!--   reshape2::melt(c("n", "id", "date", "new_confirmed", "population")) %>% -->
<!--   mutate(threshold = as.numeric(stringi::stri_extract(variable, regex = "\\d{2,3}"))) %>% -->
<!--   mutate(variable = gsub("_Q\\d{2,3}", "", variable)) %>% -->
<!--   mutate(value = value * w[n]) %>% -->
<!--   group_by(id, date, threshold, variable, new_confirmed, population) %>% -->
<!--   summarize(value = sum(value)) %>% -->
<!--   ungroup() -->

<!-- # subset critical values -->
<!-- df_crit_weight_sub <- df_crit_weight %>% -->
<!--   group_by(id, variable, threshold) %>% -->
<!--   arrange(date) %>% -->
<!--   mutate(is_crit = is_critical(new_confirmed / population * 1e5, threshold[1], min_x = 10)) %>% -->
<!--   ungroup() %>% -->
<!--   dplyr::filter(!is.na(is_crit)) -->

<!-- weighted_tpp_pl <- df_crit_weight_sub %>% -->
<!--   dplyr::filter(is_crit == "up") %>% -->
<!--   rename(group = threshold) %>% -->
<!--   plot_score() + -->
<!--   scale_x_continuous(limits = c(0, 1), expand = c(0,0), labels = function(x) x * 100) + -->
<!--   labs(x = "Weighted true positive probability (TPP)",  -->
<!--        y = "Method", -->
<!--        title = "Critical Incidence", -->
<!--        subtitle = "Weighted TPP by critical incidence") + -->
<!--   theme_bw2() -->

<!-- weighted_tpp_pl -->


<!-- weighted_fpp_pl <- df_crit_weight_sub %>% -->
<!--   dplyr::filter(is_crit == "down") %>% -->
<!--   rename(group = threshold) %>% -->
<!--   plot_score() + -->
<!--   scale_x_continuous(limits = c(0, 1), expand = c(0,0), labels = function(x) x * 100) + -->
<!--   labs(x = "Weighted false positive probability (%)",  -->
<!--        y = "Method", -->
<!--        title = "Critical incidence", -->
<!--        subtitle = "Weighted FPP by critical incidence") + -->
<!--   theme_bw2() -->

<!-- weighted_fpp_pl -->

<!-- df_crit_weight_f1 <- df_crit_weight_sub %>% -->
<!--   group_by(id, variable, is_crit, threshold) %>% -->
<!--   summarize(value = mean(value)) %>% -->
<!--   reshape2::dcast(id + variable + threshold ~ is_crit) %>% -->
<!--   mutate(f1 = up / (up + 0.5 * (down + (1-up)))) -->

<!-- weighted_f1_pl <- df_crit_weight_f1 %>% -->
<!--   rename(group = threshold, value = f1) %>% -->
<!--   plot_score() + -->
<!--   scale_x_continuous(limits = c(0, 1), expand = c(0,0), labels = function(x) x * 100) + -->
<!--   labs(x = "F1 (%)",  -->
<!--        y = "Method", -->
<!--        title = "Critical incidence", -->
<!--        subtitle = "Weighted F1-score by critical incidence", -->
<!--        caption = "Note: TPP and FPP are summarized by ID and then F1 is computed.") + -->
<!--   theme_bw2() -->

<!-- weighted_f1_pl -->

<!-- critical_pl <- arrangeGrob(weighted_tpp_pl, weighted_fpp_pl, weighted_f1_pl, ncol = 2) -->

<!-- save_plot(critical_pl, "results/critical_incidence.pdf", w = 21, h = 18) -->
<!-- ``` -->

<!-- ## Peak delay -->

<!-- ```{r} -->
<!-- df_peak <- do.call(rbind, map(files, function(f) { -->
<!--   print(sprintf("Processing file %s", f)) -->
<!--   df <- read_files(f) %>% -->
<!--     dplyr::select(id, population, new_confirmed, date, n, arima, prophet, cori) %>% -->
<!--     rowwise() %>% -->
<!--     mutate_at(vars(arima, cori, prophet), ~ list(apply(., 1, mean))) %>% -->
<!--     unnest(cols = c("n", "date", "new_confirmed", "arima", "cori", "prophet")) %>% -->
<!--     mutate_at(vars(new_confirmed, arima, cori, prophet), ~ . / population * 1e5) %>% -->
<!--     dplyr::select(id, date, n, new_confirmed, arima, cori, prophet)  -->

<!--   df %>% -->
<!--     group_by(id, n) %>% -->
<!--     nest() %>% -->
<!--     mutate(data = map(data, ~ mutate(.x, peak = is_peak(new_confirmed, min_x = 15)))) %>% -->
<!--     mutate(data = map(data, ~ mutate_at(.x, vars(arima, cori, prophet), list(peak = ~ is_closest_peak(., peak, t_right = Inf))))) %>% -->
<!--     mutate(data_peak = map(data, function(D) { -->
<!--       pd <- data.frame(cbind.fill( -->
<!--         (D$date[D$peak]), -->
<!--         (D$date[D$arima_peak]), -->
<!--         (D$date[D$cori_peak]), -->
<!--         (D$date[D$prophet_peak]), -->
<!--         (D$new_confirmed[D$peak]), -->
<!--         (D$arima[D$arima_peak]), -->
<!--         (D$cori[D$cori_peak]), -->
<!--         (D$prophet[D$prophet_peak]) -->
<!--       ), stringsAsFactors = F) %>% -->
<!--         set_names(c("obs_date", "arima_date", "cori_date", "prophet_date", -->
<!--                     "obs_inc", "arima_inc", "cori_inc", "prophet_inc")) %>% -->
<!--         mutate_at(vars(matches("date")), as.Date, origin = "1970-01-01") %>% -->
<!--         mutate_at(vars(matches("inc")), as.numeric) -->
<!--       return(pd) -->
<!--     })) %>% -->
<!--     dplyr::select(id, n, data_peak) %>% -->
<!--     unnest(cols = "data_peak") %>% -->
<!--     group_by(id, n) %>% -->
<!--     mutate(peak_no = 1:n()) %>% -->
<!--     ungroup() -->
<!-- })) -->

<!-- # nuber of peaks by country -->
<!-- df_peak %>%  -->
<!--   group_by(id) %>% -->
<!--   summarize(max(peak_no))  -->

<!-- peak_delay <- df_peak %>% -->
<!--   group_by(id) %>% -->
<!--   dplyr::filter(obs_inc == max(obs_inc)) %>% # use maximum peak for now -->
<!--   mutate_at(vars(arima_date, cori_date, prophet_date), list(ddiff = ~ n - as.numeric(. - obs_date)))  -->

<!-- peak_delay_pl <- peak_delay %>% -->
<!--   mutate(n = cut(n, breaks = n_brks, labels = n_lbs)) %>% -->
<!--   dplyr::select(id, n, matches("ddiff")) %>% -->
<!--   melt(c("id", "n")) %>% -->
<!--   mutate(variable = gsub("_date_ddiff", "", variable)) %>% -->
<!--   rename(group = n) %>% -->
<!--   plot_score(CrI = c(0.5, 0.8)) + -->
<!--   geom_vline(aes(xintercept = 0), linetype = "dotted") + -->
<!--   labs(x = "Predicted days ahead - (method peak - observed peak)",  -->
<!--        y = "Method", -->
<!--        title = "Peak delay", -->
<!--        subtitle = "Peak delay by method and weekly ahead forecast", -->
<!--        caption = "Note: Data summarized by the highest peak of each country.") + -->
<!--   theme_bw2() -->

<!-- save_plot(peak_delay_pl, "results/peak_delay.pdf", w = 21, h = 18) -->
<!-- ``` -->





