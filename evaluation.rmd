---
title: "Evaluation"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
# libraries
library(tidyverse)
library(lubridate)

# utils
source("utils/eval.r")
source("utils/delays.r")

# helper
source("utils/plotting.r")
```

## Data

```{r}
files <- list.files("predictions", pattern = ".rds", full.names = T)[1:3]
df <- map(files, readRDS)
df <- do.call(rbind, df)
df <- df %>%
  rowwise() %>%
  mutate(max_N = ifelse(is.null(dim(arima)), 1, nrow(arima))) %>%
  mutate(n_ahead = list(1:max_N)) %>%
  mutate(date_ahead = list(date %m+% days(0:(max_N-1)))) 
df$new_confirmed_ahead <- map2(df$id, df$date_ahead, function(i,d) {
  df %>% dplyr::filter(id == i) %>% dplyr::filter(date %in% d) %>%
    dplyr::select(new_confirmed) %>% unlist
})
```


## Plot predict

```{r}
df %>%
  dplyr::filter(id == "BEL") %>%
  dplyr::filter(max_N >= 11) %>%
  rowwise() %>%
  mutate_at(vars(arima, cori, prophet), ~ list(.[11,1:1000])) %>% # temporary fix
  mutate_at(vars(date_ahead, new_confirmed_ahead), ~ list(.[11])) %>% 
  unnest(cols = c("date_ahead", "new_confirmed_ahead", "arima", "cori", "prophet")) %>%
  dplyr::select(id, date_ahead, new_confirmed_ahead, arima, cori, prophet) %>%
  rename(date = date_ahead, observed = new_confirmed_ahead) %>%
  dplyr::select(-cori) %>%
  reshape2::melt(c("id", "date")) %>%
  plot_predict(interval = T)
  
df %>%
  dplyr::filter(id %in% c("BEL", "AUT")) %>%
  dplyr::filter(max_N >= 2) %>% # temporary fix (N = 1 does not work without t(as.matrix(x)))
  rowwise() %>%
  mutate_at(vars(arima, cori, prophet), ~ list(apply(., 1, mean))) %>% # temporary fix 
  unnest(cols = c("date_ahead", "new_confirmed_ahead", "n_ahead", "arima", "cori", "prophet")) %>%
  dplyr::select(id, date_ahead, new_confirmed_ahead, n_ahead, arima, cori, prophet) %>%
  rename(date = date_ahead, observed = new_confirmed_ahead) %>%
  dplyr::select(-cori) %>%
  reshape2::melt(c("id", "date", "n_ahead")) %>%
  plot_predict(interval = F)
```


## Prediction score

```{r}
df_ps <- df %>%
  dplyr::select(id, new_confirmed_ahead, n_ahead, arima, prophet, cori, population) %>%
  rowwise() %>%
  mutate_at(vars(arima, cori, prophet), ~ pred_score(., new_confirmed_ahead, population)) %>%
  unnest(cols = c("n_ahead", "arima", "cori", "prophet"))
```


### By category

```{r}
df_ps %>%
  dplyr::select(id, n_ahead, arima, cori, prophet) %>%
  reshape2::melt(c("id", "n_ahead")) %>%
  dplyr::filter(n_ahead %in% c(5, 11, 15)) %>%
  group_by(id, n_ahead, variable) %>%
  summarize(score = mean(value)) %>%
  ungroup() %>%
  plot_score(name = "Average conditional ranked probability score")
```


### Overall by N

```{r}
df_ps %>%
  dplyr::select(id, n_ahead, arima, cori, prophet) %>%
  reshape2::melt(c("id", "n_ahead")) %>%
  dplyr::filter(n_ahead %in% c(5, 10, 15)) %>%
  group_by(id, n_ahead, variable) %>%
  summarize(score = mean(value)) %>%
  ungroup() %>%
  plot_score_overall()
```


## Weighted pred error

```{r}
WM <- data_delay(30, T, p_in, mu = rnorm(1e4, 10.92, 0.94), sigma = rnorm(1e4, 5.41, 0.27))
w <- WM %>%
  group_by(x) %>%
  summarize(mean_weight = mean(value)) %>%
  dplyr::select(mean_weight) %>%
  unlist()

plot(w, xlab = "Days ahead", ylab = "Weight", type = "b")

df_ps_weighted <- df_ps %>%
  rowwise() %>%
  mutate_at(vars(arima, cori, prophet), ~ . * w[n_ahead]) 
```

### By country

```{r}
df_ps_weighted %>%
  dplyr::select(id, n_ahead, arima, cori, prophet) %>%
  reshape2::melt(c("id", "n_ahead")) %>%
  dplyr::filter(n_ahead %in% c(5, 11, 15)) %>%
  group_by(id, n_ahead, variable) %>%
  summarize(score = mean(value)) %>%
  ungroup() %>%
  plot_score("Weighted average conditional ranked probability score")
```

### Overall

```{r}
df_ps_weighted %>%
  dplyr::select(id, n_ahead, arima, cori, prophet) %>%
  reshape2::melt(c("id", "n_ahead")) %>%
  dplyr::filter(n_ahead %in% c(5, 10, 15)) %>%
  group_by(id, n_ahead, variable) %>%
  summarize(score = mean(value)) %>%
  ungroup() %>%
  plot_score_overall()
```


## Calibration

```{r}
df_cb <- df %>%
  dplyr::select(id, new_confirmed_ahead, n_ahead, arima, prophet, cori, population) %>%
  rowwise() %>%
  mutate_at(vars(arima, cori, prophet), ~ pred_score(., new_confirmed_ahead, type = "calibration")) %>%
  unnest(cols = c("n_ahead", "arima", "cori", "prophet"))

df_cb %>%
  dplyr::select(id, n_ahead, arima, cori, prophet) %>%
  reshape2::melt(c("id", "n_ahead")) %>%
  dplyr::filter(n_ahead %in% c(5, 11, 15)) %>%
  group_by(id, n_ahead, variable) %>%
  summarize(score = mean(value)) %>%
  ungroup() %>%
  plot_score(name = "Average probability to predict higher than observed value (%)",
             limits = c(0, 1), breaks = seq(0, 1, .25),
             labels = c("0.00 \n Under-predict", "0.25", "0.50 \n Well-calibrated", "0.75", "1.00 \n Over-predict"))
```


## Sharpness