---
title: "Evaluation"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
# libraries
library(tidyverse)

# utils
source("utils/eval.r")
source("utils/delays.r")
```

## Data

```{r}
files <- list.files("predictions", pattern = ".rds", full.names = T)[1:3]
df <- map(files, readRDS)
df <- do.call(rbind, df)
```


## Plot predict

```{r}
plot_predict(dat = df, countries = "AUT", method = "arima",
             start_date = "2020-10-01", end_date = "2021-01-01", 
             point_estimate = mean) 
  

plot_predict(dat = df, countries = c("AUT", "BEL"), N = c(1, 11, 21), 
             start_date = "2020-10-01", end_date = "2021-01-01", 
             point_estimate = mean) 
  

plot_predict(dat = df, countries = "AUT", method = "cori", N = 11,
             start_date = "2020-10-01", end_date = "2021-01-01") 
  

plot_predict(dat = df, countries = c("AUT", "BEL"), N = 11, 
             start_date = "2020-10-01", end_date = "2021-01-01") 
  
```


## Prediction score

```{r}
rep.pred_score <- function(y, Yhat, divisor = NULL) {
  score <- list()
  for (i in 1:length(y)) {
    if (is.null(dim(Yhat[[i]]))) { Yhat[[i]] <- t(as.matrix(Yhat[[i]])) }
    N <- nrow(Yhat[[i]])
    s <- length(N)
    for (n in 1:N) {
      s[n] <- pred_score(true = y[[i]], pred = Yhat[[i]][n, ], 
                         normalizer = ifelse(is.null(divisor), NULL, divisor[[i]]))
    }
    score[[i]] <- s
  }
  return(score)
}

df_ps <- df %>%
  dplyr::select(id, new_confirmed, arima, prophet, cori, population) %>%
  mutate(ps_arima = rep.pred_score(new_confirmed, arima, population),
         ps_cori = rep.pred_score(new_confirmed, cori, population),
         ps_prophet = rep.pred_score(new_confirmed, prophet, population)) %>%
  mutate(n_ahead = sapply(arima, function(A) if (is.null(dim(A))) { 1 } else { 1:nrow(A) } )) %>%
  unnest(cols = c("n_ahead", "ps_arima", "ps_cori", "ps_prophet")) 
  

df_ps_sum <- df_ps %>%
  dplyr::select(id, n_ahead, ps_arima, ps_cori, ps_prophet) %>%
  reshape2::melt(c("id", "n_ahead")) %>%
  mutate(variable = gsub("ps_", "", variable)) %>%
  group_by(id, variable, n_ahead) %>%
  summarize(score = mean(value)) %>%
  ungroup()
```


### By category

```{r}
plot_score(df_ps_sum, method = c("arima", "cori", "prophet"))
plot_score(df_ps_sum, method = c("arima", "prophet"))
```


### Overall by N

```{r}
plot_score_overall(df_ps_sum, method = c("arima", "cori", "prophet"))
plot_score_overall(df_ps_sum, method = c("arima", "prophet"))
```


## Weighted pred error

```{r}
WM <- data_delay(30, T, p_in, mu = rnorm(1e4, 10.92, 0.94), sigma = rnorm(1e4, 5.41, 0.27))
w <- WM %>%
  group_by(x) %>%
  summarize(mean_weight = mean(value)) %>%
  dplyr::select(mean_weight) %>%
  unlist()

plot(w, xlab = "Days ahead", ylab = "Weight", type = "b")

df_ps_weighted <- df_ps %>%
  dplyr::select(id, n_ahead, ps_arima, ps_cori, ps_prophet) %>%
  mutate(ps_arima = ps_arima * w[n_ahead],
         ps_cori = ps_cori * w[n_ahead],
         ps_prophet = ps_prophet * w[n_ahead]) %>%
  dplyr::select(-n_ahead) %>%
  reshape2::melt("id") %>%
  mutate(variable = gsub("ps_", "", variable)) %>%
  group_by(id, variable) %>%
  summarize(score = sum(value)) %>%
  ungroup()
```

### By country

```{r}
plot_score(df_ps_weighted, method = c("arima", "cori", "prophet"), weighted = T)
```

### Overall

```{r}
plot_score_overall(df_ps_weighted, weighted = T)
```


## Calibration

```{r}
plot_calibration(dat = df, N = 11)
```