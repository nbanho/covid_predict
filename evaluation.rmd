---
title: "Evaluation"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
# libraries
library(tidyverse)
library(lubridate)

# utils
source("utils/eval.r")
source("utils/delays.r")

# helper
source("helper/plotting.r")
```

## Data

```{r}
files <- list.files("predictions", pattern = ".rds", full.names = T)
```


## Plot predict

```{r}
read_files(files[1]) %>%
  get_max_N() %>%
  dplyr::filter(max_N >= 11) %>%
  rowwise() %>%
  mutate_at(vars(arima, cori, prophet), ~ list(.[11,1:1000])) %>% # temporary fix
  mutate_at(vars(date, new_confirmed), ~ list(.[11])) %>% 
  unnest(cols = c("date", "new_confirmed", "arima", "cori", "prophet")) %>%
  dplyr::select(date, new_confirmed, arima, cori, prophet) %>%
  reshape2::melt(c("date")) %>%
  plot_predict(interval = T, smoothing = 7)
  
read_files(files[1]) %>%
  rowwise() %>%
  mutate_at(vars(arima, cori, prophet), ~ list(apply(., 1, mean))) %>%
  unnest(cols = c("date", "new_confirmed", "n", "arima", "cori", "prophet")) %>%
  dplyr::select(id, date, new_confirmed, n, arima, cori, prophet) %>%
  reshape2::melt(c("id", "date", "n")) %>%
  plot_predict(interval = F, smoothing = 7)
```


## Calibration

### Probabilistic

```{r}
df_pCalib <- do.call(rbind, map(files[1:2], function(f) {
  print(sprintf("Processing file %s", f))
  read_files(f) %>%
    dplyr::select(id, population, new_confirmed, date, n, arima, prophet, cori) %>%
    rowwise() %>%
    mutate_at(vars(arima, cori, prophet), ~ pred_score(., y = new_confirmed, 
                                                       z = population / 1e5,
                                                       type = "calibration")) %>%
    unnest(cols = c("n", "date", "new_confirmed", "arima", "cori", "prophet"))
}))

df_pCalib %>%
  dplyr::filter(n %in% c(1, 7, 14, 21)) %>%
  dplyr::select(n, arima, cori, prophet) %>%
  reshape2::melt("n") %>%
  ggplot(aes(x = value)) +
  facet_wrap(~ n + variable, ncol = 3) +
  geom_histogram() +
  labs(x = "F(x)", y = "Frequency") +
  theme_bw()
```


### Marginal

```{r}
Gx <- df_pCalib %>%
  group_by(id, date) %>% 
  summarize(incidence = new_confirmed[1] / population * 1e5) %>%
  ungroup() %>%
  group_by(id) %>%
  mutate(Gx = ecdf(.$incidence)(incidence)) %>%
  ungroup() 

df_mCalib <- df_pCalib %>%
  left_join(Gx) %>%
  mutate_at(vars(arima, cori, prophet), ~ . - Gx) %>%
  mutate(incidence = as.numeric(as.character(cut(incidence, 
                                                 breaks = c(seq(0, 100, 10), seq(125, 200, 25)), 
                                                 labels = c(seq(10, 100, 10), seq(125, 200, 25)))))) %>%
  dplyr::select(n, incidence, arima, cori, prophet) %>%
  reshape2::melt(c("n", "incidence")) %>%
  group_by(n, incidence, variable) %>%
  summarize(value = mean(value)) %>%
  ungroup() 

df_mCalib %>%
  dplyr::filter(n %in% c(1, 7, 14, 21)) %>%
  ggplot(aes(x = incidence, y = value, color = variable)) +
  geom_line() +
  facet_wrap(~ n) +
  geom_hline(aes(yintercept = 0), linetype = "dotted") +
  scale_color_brewer(palette = "Dark2") +
  labs(x = "Incidence (x = cases per 100,000 pop.)", 
       y = "F(x) - G(X)") +
  theme_bw() +
  theme(legend.position = "top", legend.title = element_blank())
```


## Sharpness

```{r}
df_sharp <- do.call(rbind, map(files[1:2], function(f) {
  print(sprintf("Processing file %s", f))
  read_files(f) %>%
    dplyr::select(id, new_confirmed, date, n, arima, prophet, cori, population) %>%
    rowwise() %>%
    mutate_at(vars(arima, cori, prophet), list(Q50 = ~ pred_score(., new_confirmed, 
                                                             population / 1e5, 
                                                             type = "sharpness", 
                                                             q = 0.25))) %>%
    mutate_at(vars(arima, cori, prophet), list(Q90 = ~ pred_score(., new_confirmed, 
                                                             population / 1e5, 
                                                             type = "sharpness", 
                                                             q = 0.05))) %>%
    dplyr::select(-arima, -cori, -prophet) %>%
    unnest(cols = c("n", "date", "new_confirmed", 
                    "arima_Q50", "cori_Q50", "prophet_Q50",
                    "arima_Q90", "cori_Q90", "prophet_Q90"))
}))

df_sharp %>%
  dplyr::filter(n %in% c(1, 7, 14, 21)) %>%
  reshape2::melt(c("id", "n", "date", "new_confirmed", "population")) %>%
  mutate(variable = factor(variable, levels = c("arima_Q50", "cori_Q50", "prophet_Q50",
                                                "arima_Q90", "cori_Q90", "prophet_Q90"))) %>%
  ggplot(aes(x = variable, y = value)) +
  facet_wrap(~ n) +
  geom_boxplot() +
  labs(x = "Model and Q%-CrI", y = "Size of Q%-CrI") +
  theme_bw()
```


## CRPS

```{r}
df_ps <- do.call(rbind, map(files[1:5], function(f) {
  print(sprintf("Processing file %s", f))
  read_files(f) %>%
    rowwise() %>%
    mutate_at(vars(arima, cori, prophet), ~ pred_score(., new_confirmed, type = "crps")) %>%
    unnest(cols = c("n", "date", "new_confirmed", "arima", "cori", "prophet"))
}))
```


### By N

```{r}
df_ps %>%
  mutate(group = cut(n, breaks = c(0, 5, 10, 15, 21), 
                     labels = paste(c("short", "medium", "long", "very long"), "forecast", sep = " "))) %>%
  dplyr::select(id, group, arima, cori, prophet) %>%
  reshape2::melt(c("id", "group")) %>%
  plot_score(x = "CRPS", y = "Method")
```


## Weighted CRPS

```{r}
WM <- data_delay(30, T, p_in, mu = rnorm(1e4, 10.92, 0.94), sigma = rnorm(1e4, 5.41, 0.27))
w <- WM %>%
  group_by(x) %>%
  summarize(mean_weight = mean(value)) %>%
  dplyr::select(mean_weight) %>%
  unlist()

plot(w, xlab = "Days ahead", ylab = "Weight", type = "b")

df_ps_weighted <- df_ps %>%
  rowwise() %>%
  mutate_at(vars(arima, cori, prophet), ~ . * w[n]) 
```

### By ID

```{r}
df_ps_weighted %>%
  dplyr::select(id, arima, cori, prophet) %>%
  reshape2::melt(c("id")) %>% 
  rename(group = id) %>%
  plot_score(x = "Weighted CRPS", y = "Method")
```

### By incidence

```{r}
df_ps_weighted %>%
  mutate(incidence = new_confirmed / population * 1e5) %>%
  mutate(group = cut(incidence, breaks = c(0, 30, 50, 100, Inf), 
                     labels = paste(c("low", "medium", "high", "very high"), "incidence", sep = " "))) %>%
  dplyr::select(id, group, arima, cori, prophet) %>%
  reshape2::melt(c("id", "group")) %>%
  plot_score(x = "Weighted CRPS", y = "Method")
```



## Policy metric

### Week of peak incidence

### Peak incidence

### Week of onset





